# Выбор и настройка мониторинга в системе

## Мотивация

Внедрение сбора технических и бизнес-метрик о работе сервиса.

Преимущества внедрения мониторинга:
 - Выявление наиболее нагруженных сервисов для оптимального распределения ресурсов
 - Выявление узких мест в системе, устранение которых позволит с наименьшими затратами повысить надежность системы
 - Выявление аномалий в работе системы, таких как пиковые нагрузки
 - Отслеживание состояния системы, например количество ошибок 5xx и 4xx для возможности оперативного реагирования до того как пользователи начнут жаловаться

С точки зрения трудозатрат внедрение мониторинга не требует много ресурсов и знаний благодаря наличию готовых решений и библиотек для разных языков программирования,
в том числе Java и C# используемым в проекте 

## Выбор подхода к мониторингу

- Shop API - RED
- MES - USE
- SRM API - RED

## Метрики для отслеживания

- Number of requests (RPS) for internet shop API
- Number of requests (RPS) for CRM API
- Number of requests (RPS) for MES API
- Number of requests (RPS) per user for MES API (Только для партнеров, лейбл - user ID)
- CPU % for shop API 
- CPU % for CRM API 
- CPU % for MES API
- Memory Utilisation for shop API
- Memory Utilisation for MES API
- Memory Utilisation for MES db instance
- Number of connections for shop db instance
- Response time (latency) for shop API (лейбл - эндпоинт)
- Response time (latency) for CRM API (лейбл - эндпоинт)
- Response time (latency) for MES API (лейбл - эндпоинт)
- Number of HTTP 200 for shop API (лейбл - эндпоинт)
- Number of HTTP 500 for shop API (лейбл - эндпоинт)
- Number of HTTP 500 for CRM API (лейбл - эндпоинт)
- Number of HTTP 500 for MES API (лейбл - эндпоинт)
- Number of HTTP 500 for shop API (лейбл - эндпоинт)
- Kb transferred (received) for MES API
- Kb provided (sent) for MES API

## Дополнительные метрики

- Количество выполненных заказов
- Количество активных пользователей DAU и MAU
- Количество загруженных файлов в S3
- Время обработки файла в MES
- Тротлинг CPU

## План действий

- Развернуть Prometheus на виртуальной машине c встроенной TSDB на локальном диске или как сервис в облаке
- Развернуть Grafana на другой виртуальной машине или как сервисс в облаке
- Настроить подключение Grafana к Prometheus
- Подключить библиотеку prometheus-net или другое решение в систему MES и настроить необходимые метрики, опубликовать эндпоинт /metrics
- Подключить prometheus/client_java или другое решение в сервисы на Java и настроить необходимые метрики, опубликовать эндпоинт /metrics
- Настроить Prometheus для пула метрик с вышеуказанных сервисов
- Настроить графики в Grafana и создать дашборд с ключевыми метриками
- Настроить алертинг на превышене допустимых значений

## Дополнительное задание - метрики насыщенности
- Среднее время обработки файла в MES - пороговое значение 10-15 мин.
- Memory Utilisation - пороговое значение 70-80%
- Response time (latency) - пороговое значение 400-600 ms для api сервисов
- CPU % - пороговое значение 90%

При превышении пороговых значений выполнять отправку письма ответственным за сервис
При превышении времени обработки файла в MES можно отправлять событие об этом в систему и уведомлять в интерфейсе об увеличении времени обработки в связи с повышенной нагрузкой
